// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN
  EMPLOYEE
}

enum MachineType {
  CNC
  LASER
  CHAMPS
  PANNEAUX
}

enum DevisStatus {
  DRAFT
  VALIDATED
  INVOICED
  CANCELLED
}

// ==================== MODELS ====================

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  password      String    // bcrypt hashed
  firstName     String
  lastName      String
  role          UserRole  @default(EMPLOYEE)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  allowedMachines UserMachine[]
  createdDevis    Devis[]       @relation("CreatedBy")
  
  @@map("users")
}

model UserMachine {
  id        String      @id @default(uuid())
  userId    String
  machine   MachineType
  
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, machine])
  @@map("user_machines")
}

model Client {
  id          String    @id @default(uuid())
  name        String
  phone       String?
  email       String?
  address     String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  devis       Devis[]
  
  @@map("clients")
}

model MachinePricing {
  id            String      @id @default(uuid())
  machineType   MachineType @unique
  pricePerUnit  Decimal     @db.Decimal(10, 2)  // per minute, per meter, or per unit
  description   String?
  updatedAt     DateTime    @updatedAt
  
  @@map("machine_pricing")
}

model Material {
  id          String    @id @default(uuid())
  name        String
  pricePerUnit Decimal  @db.Decimal(10, 2)
  unit        String    // "mÂ²", "piece", "meter"
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  devisLines  DevisLine[]
  
  @@map("materials")
}

model FixedService {
  id          String    @id @default(uuid())
  name        String    // "Design", "Finishing", "Delivery"
  price       Decimal   @db.Decimal(10, 2)
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  devisServices DevisService[]
  
  @@map("fixed_services")
}

model Devis {
  id            String      @id @default(uuid())
  reference     String      @unique  // DEV-2024-0001
  status        DevisStatus @default(DRAFT)
  totalAmount   Decimal     @db.Decimal(12, 2) @default(0)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  validatedAt   DateTime?
  
  // Relations
  clientId      String
  client        Client      @relation(fields: [clientId], references: [id])
  
  createdById   String
  createdBy     User        @relation("CreatedBy", fields: [createdById], references: [id])
  
  lines         DevisLine[]
  services      DevisService[]
  invoice       Invoice?
  
  @@map("devis")
}

model DevisLine {
  id            String      @id @default(uuid())
  machineType   MachineType
  description   String?
  
  // Calculation inputs
  minutes       Decimal?    @db.Decimal(10, 2)  // For CNC, Laser
  meters        Decimal?    @db.Decimal(10, 2)  // For Champs
  quantity      Int?                             // For Panneaux
  
  // Pricing at time of creation
  unitPrice     Decimal     @db.Decimal(10, 2)
  materialCost  Decimal     @db.Decimal(10, 2) @default(0)
  lineTotal     Decimal     @db.Decimal(12, 2)
  
  createdAt     DateTime    @default(now())
  
  // Relations
  devisId       String
  devis         Devis       @relation(fields: [devisId], references: [id], onDelete: Cascade)
  
  materialId    String?
  material      Material?   @relation(fields: [materialId], references: [id])
  
  @@map("devis_lines")
}

model DevisService {
  id            String    @id @default(uuid())
  price         Decimal   @db.Decimal(10, 2)  // Price at time of creation
  
  // Relations
  devisId       String
  devis         Devis     @relation(fields: [devisId], references: [id], onDelete: Cascade)
  
  serviceId     String
  service       FixedService @relation(fields: [serviceId], references: [id])
  
  @@map("devis_services")
}

model Invoice {
  id            String    @id @default(uuid())
  reference     String    @unique  // INV-2024-0001
  pdfUrl        String?
  createdAt     DateTime  @default(now())
  
  // Relations
  devisId       String    @unique
  devis         Devis     @relation(fields: [devisId], references: [id])
  
  @@map("invoices")
}
