generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================
// UserRole: ADMIN | EMPLOYEE
// MachineType: CNC | LASER | CHAMPS | PANNEAUX
// DevisStatus: DRAFT | VALIDATED | INVOICED | CANCELLED

// ==================== MODELS ====================

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  password      String    // bcrypt hashed
  firstName     String
  lastName      String
  role          String    @default("EMPLOYEE") // ADMIN | EMPLOYEE
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  allowedMachines UserMachine[]
  createdDevis    Devis[]       @relation("CreatedBy")
  createdExpenses Expense[]     @relation("ExpenseCreatedBy")
  triggeredNotifications Notification[] @relation("NotificationTriggeredBy")
  
  @@map("users")
}

model UserMachine {
  id        String    @id @default(uuid())
  userId    String
  machine   String    // CNC | LASER | CHAMPS | PANNEAUX
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, machine])
  @@map("user_machines")
}

model Client {
  id          String    @id @default(uuid())
  name        String
  phone       String?
  email       String?
  address     String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  devis       Devis[]
  invoices    Invoice[]
  
  @@map("clients")
}

model MachinePricing {
  id            String    @id @default(uuid())
  machineType   String    @unique // CNC | LASER | CHAMPS | PANNEAUX
  pricePerUnit  Decimal   // per minute, per meter, or per unit
  description   String?
  updatedAt     DateTime  @updatedAt
  
  @@map("machine_pricing")
}

model Material {
  id          String    @id @default(uuid())
  name        String
  pricePerUnit Decimal
  unit        String    // "m²", "piece", "meter"
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  devisLines  DevisLine[]
  
  @@map("materials")
}

model FixedService {
  id          String    @id @default(uuid())
  name        String    // "Design", "Finishing", "Delivery"
  price       Decimal
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  devisServices DevisService[]
  
  @@map("fixed_services")
}

model Devis {
  id            String    @id @default(uuid())
  reference     String    @unique  // DEV-2024-0001
  status        String    @default("DRAFT") // DRAFT | VALIDATED | INVOICED | CANCELLED
  totalAmount   Decimal   @default(0)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  validatedAt   DateTime?
  
  // Relations
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  createdById   String
  createdBy     User      @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  
  lines         DevisLine[]
  services      DevisService[]
  
  invoiceId     String?
  invoice       Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  
  @@map("devis")
}

model DevisLine {
  id            String    @id @default(uuid())
  machineType   String    // CNC | LASER | CHAMPS | PANNEAUX
  description   String?
  
  // Calculation inputs
  minutes       Decimal?  // For CNC, Laser
  meters        Decimal?  // For Champs
  quantity      Int?      // For Panneaux
  
  // Pricing at time of creation
  unitPrice     Decimal
  materialCost  Decimal   @default(0)
  lineTotal     Decimal
  
  createdAt     DateTime  @default(now())
  
  // Relations
  devisId       String
  devis         Devis     @relation(fields: [devisId], references: [id], onDelete: Cascade)
  
  materialId    String?
  material      Material? @relation(fields: [materialId], references: [id])
  
  @@map("devis_lines")
}

model DevisService {
  id            String    @id @default(uuid())
  price         Decimal   // Price at time of creation
  
  // Relations
  devisId       String
  devis         Devis     @relation(fields: [devisId], references: [id], onDelete: Cascade)
  
  serviceId     String
  service       FixedService @relation(fields: [serviceId], references: [id])
  
  @@map("devis_services")
}

model Invoice {
  id            String    @id @default(uuid())
  reference     String    @unique  // INV-2024-0001
  totalAmount   Decimal   @default(0)  // Sum of all devis amounts or items
  pdfUrl        String?
  createdAt     DateTime  @default(now())
  
  // Relations
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id])
  
  devis         Devis[]
  items         InvoiceItem[]
  payments      Payment[]
  
  @@map("invoices")
}

model InvoiceItem {
  id            String    @id @default(uuid())
  description   String
  quantity      Decimal   @default(1)
  unitPrice     Decimal
  totalPrice    Decimal
  createdAt     DateTime  @default(now())
  
  // Relations
  invoiceId     String
  invoice       Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("invoice_items")
}

model Payment {
  id            String    @id @default(uuid())
  amount        Decimal
  paymentDate   DateTime  @default(now())
  paymentMethod String?   // "Cash", "Check", "Bank Transfer", "Credit Card", etc.
  reference     String?   // Check number, transaction ID, etc.
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  invoiceId     String
  invoice       Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("payments")
}

model Expense {
  id            String    @id @default(uuid())
  description   String
  amount        Decimal
  category      String    // "Matériel", "Fournitures", "Transport", "Maintenance", "Salaires", "Loyer", "Électricité", "Autre"
  date          DateTime  @default(now())
  reference     String?   // Receipt number, invoice number, etc.
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  createdById   String
  createdBy     User      @relation("ExpenseCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  
  @@map("expenses")
}

model Notification {
  id            String    @id @default(uuid())
  type          String    // "CLIENT_CREATED", "DEVIS_CREATED", "INVOICE_CREATED", "EXPENSE_CREATED", "PAYMENT_RECEIVED", etc.
  title         String
  message       String
  entityType    String?   // "client", "devis", "invoice", "expense", "payment"
  entityId      String?   // ID of the related entity
  isRead        Boolean   @default(false)
  createdAt     DateTime  @default(now())
  
  // Relations - notification triggered by this user
  triggeredById String?
  triggeredBy   User?     @relation("NotificationTriggeredBy", fields: [triggeredById], references: [id], onDelete: SetNull)
  
  @@map("notifications")
}
