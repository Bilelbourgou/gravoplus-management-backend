generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS (as String for SQLite) ====================
// UserRole: ADMIN | EMPLOYEE
// MachineType: CNC | LASER | CHAMPS | PANNEAUX
// DevisStatus: DRAFT | VALIDATED | INVOICED | CANCELLED

// ==================== MODELS ====================

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  password      String    // bcrypt hashed
  firstName     String
  lastName      String
  role          String    @default("EMPLOYEE") // ADMIN | EMPLOYEE
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  allowedMachines UserMachine[]
  createdDevis    Devis[]       @relation("CreatedBy")
  
  @@map("users")
}

model UserMachine {
  id        String    @id @default(uuid())
  userId    String
  machine   String    // CNC | LASER | CHAMPS | PANNEAUX
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, machine])
  @@map("user_machines")
}

model Client {
  id          String    @id @default(uuid())
  name        String
  phone       String?
  email       String?
  address     String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  devis       Devis[]
  
  @@map("clients")
}

model MachinePricing {
  id            String    @id @default(uuid())
  machineType   String    @unique // CNC | LASER | CHAMPS | PANNEAUX
  pricePerUnit  Decimal   // per minute, per meter, or per unit
  description   String?
  updatedAt     DateTime  @updatedAt
  
  @@map("machine_pricing")
}

model Material {
  id          String    @id @default(uuid())
  name        String
  pricePerUnit Decimal
  unit        String    // "mÂ²", "piece", "meter"
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  devisLines  DevisLine[]
  
  @@map("materials")
}

model FixedService {
  id          String    @id @default(uuid())
  name        String    // "Design", "Finishing", "Delivery"
  price       Decimal
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  devisServices DevisService[]
  
  @@map("fixed_services")
}

model Devis {
  id            String    @id @default(uuid())
  reference     String    @unique  // DEV-2024-0001
  status        String    @default("DRAFT") // DRAFT | VALIDATED | INVOICED | CANCELLED
  totalAmount   Decimal   @default(0)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  validatedAt   DateTime?
  
  // Relations
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id])
  
  createdById   String
  createdBy     User      @relation("CreatedBy", fields: [createdById], references: [id])
  
  lines         DevisLine[]
  services      DevisService[]
  invoice       Invoice?
  
  @@map("devis")
}

model DevisLine {
  id            String    @id @default(uuid())
  machineType   String    // CNC | LASER | CHAMPS | PANNEAUX
  description   String?
  
  // Calculation inputs
  minutes       Decimal?  // For CNC, Laser
  meters        Decimal?  // For Champs
  quantity      Int?      // For Panneaux
  
  // Pricing at time of creation
  unitPrice     Decimal
  materialCost  Decimal   @default(0)
  lineTotal     Decimal
  
  createdAt     DateTime  @default(now())
  
  // Relations
  devisId       String
  devis         Devis     @relation(fields: [devisId], references: [id], onDelete: Cascade)
  
  materialId    String?
  material      Material? @relation(fields: [materialId], references: [id])
  
  @@map("devis_lines")
}

model DevisService {
  id            String    @id @default(uuid())
  price         Decimal   // Price at time of creation
  
  // Relations
  devisId       String
  devis         Devis     @relation(fields: [devisId], references: [id], onDelete: Cascade)
  
  serviceId     String
  service       FixedService @relation(fields: [serviceId], references: [id])
  
  @@map("devis_services")
}

model Invoice {
  id            String    @id @default(uuid())
  reference     String    @unique  // INV-2024-0001
  pdfUrl        String?
  createdAt     DateTime  @default(now())
  
  // Relations
  devisId       String    @unique
  devis         Devis     @relation(fields: [devisId], references: [id])
  payments      Payment[]
  
  @@map("invoices")
}

model Payment {
  id            String    @id @default(uuid())
  amount        Decimal
  paymentDate   DateTime  @default(now())
  paymentMethod String?   // "Cash", "Check", "Bank Transfer", "Credit Card", etc.
  reference     String?   // Check number, transaction ID, etc.
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  invoiceId     String
  invoice       Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@map("payments")
}
